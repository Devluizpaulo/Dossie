{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user with access to the BMV Dossier Viewer application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "email": {
          "type": "string",
          "description": "The user's institutional email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The role of the user, which determines their access level.",
          "enum": ["admin_master", "user"]
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "role"
      ]
    },
    "AccessAttempt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AccessAttempt",
      "type": "object",
      "description": "Stores information about user access attempts, including the token and security code.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the access attempt."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User associated with this access attempt. (Relationship: User 1:N AccessAttempt)"
        },
        "accessCode": {
          "type": "string",
          "description": "The one time access code sent to the user's email.  This code is time-sensitive."
        },
        "securityCode": {
          "type": "string",
          "description": "The security code the user must enter to access the panel after successful login."
        },
        "attemptedAt": {
          "type": "string",
          "description": "Timestamp of when the access attempt was made.",
          "format": "date-time"
        },
        "isSuccessful": {
          "type": "boolean",
          "description": "Indicates whether the access attempt was successful or not."
        }
      },
      "required": [
        "id",
        "userId",
        "accessCode",
        "securityCode",
        "attemptedAt",
        "isSuccessful"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. The 'userId' parameter is the unique identifier for the user.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/accessAttempts/{accessAttemptId}",
        "definition": {
          "entityName": "AccessAttempt",
          "schema": {
            "$ref": "#/backend/entities/AccessAttempt"
          },
          "description": "Stores access attempts associated with a user. Uses path-based ownership for simplified security rules. The 'userId' parameter is the unique identifier for the user. The 'accessAttemptId' parameter is the unique identifier for the access attempt.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "accessAttemptId",
              "description": "Unique identifier for the access attempt."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure prioritizes security and efficiency for the BMV Dossier Viewer application. It employs path-based ownership and denormalization to ensure authorization independence, enabling atomic operations and simplifying security rules. Since the application requires email/token based authentication and post login security code validation, the `users/{userId}/accessAttempts/{accessAttemptId}` subcollection enforces path-based ownership, providing a straightforward way to control access. The separation of concerns enforced by storing user data and access attempts in dedicated collections simplifies security rules and enhances debuggability. This approach eliminates the need for complex queries or `get()` calls in security rules, as authorization is based solely on the authenticated user's ID and path-based ownership.\n\n**QAPs (Rules are not Filters)**\n*   The chosen structure uses dedicated collections for different data types (users and access attempts), ensuring that list operations can be secured effectively without filtering data based on its content.  Path based ownership provides a straightforward approach to securing user specific data."
  }
}
